# Después de workbook.save(filename=ruta_compartido)
import win32com.client

# Forzar recalculación usando pywin32
excel = win32com.client.Dispatch("Excel.Application")
excel.Visible = False  # No mostrar Excel
workbook = excel.Workbooks.Open(ruta_compartido)
excel.Calculate()  # Forzar recalculación a nivel de aplicación
workbook.Save()
workbook.Close()
excel.Quit()

# Continúa con el resto del código
import pandas as pd
import matplotlib.pyplot as plt

# Recargar el Excel con pandas
df_full = pd.read_excel(ruta_compartido)
print("Columnas disponibles:", df_full.columns)
print("Primeras filas:", df_full.head())

# Convertir "Fecha" a datetime
df_full["Fecha"] = pd.to_datetime(df_full["Fecha"], errors='coerce')
df_full = df_full.sort_values(by="Fecha")

# Generar gráfico evolutivo
plt.figure(figsize=(10, 5))
plt.plot(df_full["Fecha"], df_full["Transacciones Faltantes"], label="Transacciones Faltantes", color="blue")
plt.title("Evolución de Transacciones Faltantes")
plt.xlabel("Fecha")
plt.ylabel("Transacciones Faltantes")
plt.legend()
plt.grid(True)
plt.xticks(rotation=45)
plt.tight_layout()
plt.savefig("evolucion_txs.png")
plt.close()

# [Siguiente celda] Configuración del correo
outlook = win32.Dispatch('outlook.application')
mail = outlook.CreateItem(0)
# ... (resto del código del correo)

========
# [Siguiente celda] Configuración del correo
outlook = win32.Dispatch('outlook.application')
mail = outlook.CreateItem(0)

# Configurar el asunto
mail.Subject = f"Informe Transacciones de Monitor al {df_full['Fecha'].max().strftime('%d %m %Y')}"

# Configurar el cuerpo del correo con HTML e imagen incrustada
mail.HTMLBody = f"""
<html><body>
<h3>Estimados,</h3>
<p>Adjunto encontrarán el informe con la evolución mensual de las transacciones faltantes.</p>
<div><img src="cid:evolucion_mensual_txs.png" alt="Evolución Mensual de Transacciones Faltantes" style="width:600px;"></div>
<p>Saludos,</p>
<p>Tu Nombre</p>
</body></html>
"""

# Adjuntar la imagen
attachment = mail.Attachments.Add("evolucion_mensual_txs.png")
attachment.PropertyAccessor.SetProperty("http://schemas.microsoft.com/mapi/proptag/0x3712001E", "evolucion_mensual_txs.png")

# Enviar el correo
mail.Send()